
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATP Random Question ✈️ 문제풀기 (REAL FINAL FIX)</title>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard&display=swap" rel="stylesheet">
</head>
<body>
  <div class="card">
    <h1>ATP Random Question ✈️</h1>
    <div id="scoreboard">문제 로딩 중...</div>
    <div id="question">잠시만 기다려주세요...</div>
    <div id="choices"></div>
    <div id="feedback"></div>
    <div id="answer"></div>
    <button type="button" id="next-btn" style="display:none;">다음 문제</button>
    <button type="button" id="home-btn" style="display:none;" onclick="location.href='./index.html'">메인페이지로 돌아가기</button>
    <button type="button" id="reset-btn" style="display:none;" onclick="resetWrongNotes()">오답노트 초기화</button>
  </div>

<script>
const params = new URLSearchParams(window.location.search);
const book = params.get('book') || 'atp';
const mode = params.get('mode') || 'normal';

let currentProblems = [];
let wrongNotes = JSON.parse(localStorage.getItem('wrongNotes') || '[]');
let current = 0;
let correctCount = 0;
let totalCount = 0;
let answered = false;

function extractCorrectAnswer(problem) {
  if (!problem.correct) return '';
  if (book === 'atp') {
    const match = problem.correct.match(/\(([A-D])\)/i);
    return match ? match[1].toUpperCase() : '';
  } else {
    const match = problem.correct.match(/\d/);
    return match ? match[0] : '';
  }
}

function getSelectedAnswer(selectedText) {
  const firstChar = selectedText.trim().charAt(0);
  if (book === 'atp') {
    return firstChar.toUpperCase();
  } else {
    switch (firstChar) {
      case '①': return '1';
      case '②': return '2';
      case '③': return '3';
      case '④': return '4';
      default: return '';
    }
  }
}

function setupQuiz(loadedProblems) {
  if (mode === 'wrongnote') {
    currentProblems = wrongNotes.length > 0 ? [...wrongNotes] : [];
  } else {
    currentProblems = [...loadedProblems];
  }
  if (!currentProblems || currentProblems.length === 0) {
    finishQuiz();
    return;
  }
  document.getElementById('next-btn').style.display = 'block';
  document.getElementById('home-btn').style.display = 'block';
  document.getElementById('reset-btn').style.display = 'block';
  nextQuestion();
}

function updateScoreboard() {
  let percentage = totalCount === 0 ? 0 : Math.round((correctCount / totalCount) * 100);
  document.getElementById('scoreboard').innerText = 
    `현재까지 ${totalCount}문제 풀었고, ${correctCount}문제 맞췄습니다. (정답률 ${percentage}%)`;
}

function nextQuestion() {
  if (!currentProblems || currentProblems.length === 0) {
    finishQuiz();
    return;
  }
  const randomIndex = Math.floor(Math.random() * currentProblems.length);
  current = randomIndex;
  answered = false;
  document.getElementById('question').innerText = currentProblems[randomIndex].question;
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';
  currentProblems[randomIndex].choices.forEach(choice => {
    const btn = document.createElement('button');
    btn.textContent = choice;
    btn.onclick = () => checkAnswer(choice);
    choicesDiv.appendChild(btn);
  });
  document.getElementById('feedback').innerText = '';
  document.getElementById('answer').style.display = 'none';
}

function checkAnswer(selected) {
  if (answered) return;
  answered = true;
  totalCount += 1;

  const correct = extractCorrectAnswer(currentProblems[current]);
  const selectedValue = getSelectedAnswer(selected);

  if (selectedValue === correct) {
    correctCount += 1;
    document.getElementById('feedback').innerText = '정답입니다! 🎯';
    document.getElementById('feedback').style.color = 'green';
  } else {
    document.getElementById('feedback').innerText = `오답입니다 😢 정답은 (${correct})입니다.`;
    document.getElementById('feedback').style.color = 'red';
    if (mode === 'normal') {
      wrongNotes.push(currentProblems[current]);
      localStorage.setItem('wrongNotes', JSON.stringify(wrongNotes));
    }
  }
  document.getElementById('answer').innerText = currentProblems[current].explanation || "";
  document.getElementById('answer').style.display = 'block';
  currentProblems.splice(current, 1);
  updateScoreboard();
}

function finishQuiz() {
  document.getElementById('scoreboard').innerText = "🎉 모든 문제를 다 풀었습니다!";
  document.getElementById('question').innerText = "남은 문제가 없습니다.";
  document.getElementById('choices').innerHTML = '';
  document.getElementById('feedback').innerText = '';
  document.getElementById('answer').style.display = 'none';
  document.getElementById('next-btn').style.display = 'none';
  document.getElementById('home-btn').style.display = 'block';
}

function resetWrongNotes() {
  localStorage.removeItem('wrongNotes');
  alert('오답노트가 초기화되었습니다! 메인페이지로 이동합니다.');
  location.href = './index.html';
}

const script = document.createElement('script');
script.src = (book === 'flight_theory') 
  ? 'https://henrypark-kr.github.io/atp-quiz/problems_flight_theory.js' 
  : 'https://henrypark-kr.github.io/atp-quiz/problems.js';
document.head.appendChild(script);
script.onload = () => {
  setupQuiz(problems);
};

document.getElementById('next-btn').addEventListener('click', nextQuestion);
</script>

</body>
</html>
